name: Deploy shell (root)

on:
  push:
    branches: ["main"]
    paths:
      - "invest-web/projects/shell/**"
  workflow_dispatch:

env:
  SHELL_ASSETS_URL: ${{ vars.SHELL_ASSETS_URL }}
  MANIFEST_URL: ${{ vars.MANIFEST_URL }}
  APP: shell
  BUILD_DIR: invest-web/dist/shell/browser
  DESTINATION_DIR: "/"
  SHELL_CLOUDFLARE_PROJECT_NAME: ${{ vars.SHELL_CLOUDFLARE_PROJECT_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: invest-web

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: npm ci

      - name: Replace tokens
        uses: cschleiden/replace-tokens@v1
        with:
          tokenPrefix: "#{"
          tokenSuffix: "}#"
          files: |
            invest-web/projects/${{ env.APP }}/src/environments/environment.ts
        env:
          assetsUrl: ${{ env.SHELL_ASSETS_URL }}
          manifestUrl: ${{ env.MANIFEST_URL }}

      - name: Build Shell
        run: npm run build -- ${{ env.APP }}

      - name: Publish to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ${{ env.BUILD_DIR }} --project-name=${{ env.SHELL_CLOUDFLARE_PROJECT_NAME }}
